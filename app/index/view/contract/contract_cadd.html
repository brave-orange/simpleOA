<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="__STATIC__/layui/css/layui.css"  media="all">
    <script type="text/javascript" src="__STATIC__/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="__STATIC__/layer/layer/layer.js"></script>
    <script src="__STATIC__/layui/layui.js"></script>
    <style>
        table input[type='text']{
            width:100%;
            height:100%;}
        .layui-table td{
            padding:0;
        }
        .hide{
            display:none;
        }
    </style>
</head>
<body>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
    <legend>添加采购合同基本信息</legend>
</fieldset>
<form class="layui-form" action="" enctype="multipart/form-data">
    <!--弹出层-->
    <div id="goodsInfo" class="hide">
        <!--<form class="layui-form" id="goodsinfo_form">-->
        <div class="layui-form-item">
            <label class="layui-form-label">商品名称</label>
            <div class="layui-input-inline">
                <select id="goods" name="goods" lay-verify="required" lay-search="">
                    <option value="0">商品0</option>
                    <option value="6">商品1</option>
                    <option value="7">商品2</option>
                </select>
            </div>
            <label class="layui-form-label">商品种类</label>
            <div class="layui-input-inline">
                <select id="goods_type" name="goods_type" lay-verify="required" lay-search="">
                    {foreach :model('goods','service')->goods_type() as $key=>$val}
                    <option value="{$val.goods_type_id}">{$val.goods_type}</option>
                    {/foreach}
                </select>
            </div>

        </div>
        <div class="layui-form-item">
        <label class="layui-form-label">商品型号</label>
        <div class="layui-input-inline">
            <select id="norms_name" name="norms_name" lay-verify="">
                <option value="0">商品0</option>
                <option value="6">商品1</option>
                <option value="7">商品2</option>
                <option value="8">商品3</option>
            </select>
        </div>
            <label class="layui-form-label">商品产地</label>
            <div class="layui-input-inline">
                <select id="manufacturer" name="manufacturer" lay-verify="">
                    <option value="0">商品0</option>
                    <option value="6">商品1</option>
                    <option value="7">商品2</option>
                    <option value="8">商品3</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品单价</label>
            <div class="layui-input-inline">
                <input type="number" name="price" placeholder="请填写单价" lay-verify="required" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">/<span>元</span></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品数量</label>
            <div class="layui-input-inline">
                <input type="number" name="num" required  lay-verify="required" placeholder="请输入数量" autocomplete="off" class="layui-input">
            </div>
            <label class="layui-form-label">计量单位</label>
            <div class="layui-input-inline">
                <select name="unit" lay-verify="required" lay-search="">
                    <option value="8">商品3</option>
                </select>
            </div>
        </div>
        <!--</form>-->
    </div>
    <!--弹出层-->
    <div class="layui-form" style="height:215px">
        <button type="button" id="layuipro" class="layui-btn layui-btn-normal" id="" style="margin-left:25px"><i class="layui-icon">&#xe654;</i>选择商品信息</button>
        <table class="layui-table" lay-filter="test" id="demo">
        <colgroup>
            <col width="150">
            <col width="150">
            <col width="150">
            <col width="150">
            <col width="150">
            <col width="150">
        </colgroup>
        <thead>
        <tr>
            <!--<th>商品名称</th>-->
            <!--<th>商品单价</th>-->
            <!--<th>货币单位</th>-->
            <!--<th>商品数量</th>-->
            <!--<th>数量单位</th>-->
            <!--<th>总价</th>-->
        <!--</tr>-->
        </thead>
    </table>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">客户名称:</label>
        <div class="layui-input-inline">
            <input type="text" name="business_name" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">采购金额:</label>
        <div class="layui-input-inline">
            <input type="text" name="money" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input">
        </div>
    </div>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"></fieldset>
    <div class="layui-form-item">
        <label class="layui-form-label">采购定金:</label>
        <div class="layui-input-inline">
            <input type="text" name="earnest_money" placeholder="请输入" autocomplete="off" class="layui-input">
        </div>
    </div>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"></fieldset>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:86px">对应销售合同</label>
        <div class="layui-input-inline">
            <input type="text" name="xs_contract_id" lay-verify="required" placeholder="销售合同编号(必填)" autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label" style="width:85px">余款预约时间</label>
        <div class="layui-inline"> <!-- 注意：这一层元素并不是必须的 -->
            <input type="text" class="layui-input" id="test2">
        </div>
    </div>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    </fieldset>
    <div class="layui-form-item">
        <label class="layui-form-label">创建日期</label>
        <div class="layui-inline"> <!-- 注意：这一层元素并不是必须的 -->
            <input type="text" class="layui-input" id="test1">
        </div>
        <button type="button" class="layui-btn layui-btn-normal" id="test3"><i class="layui-icon">&#xe654;</i>选择附件照片</button>
    </div>
    <div class="layui-upload-list">
        <table class="layui-table">
            <thead>
            <tr>
                <th>文件名</th>
                <th>大小</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="demoList"></tbody>
        </table>
    </div>
    <div style="margin-top: 20px;"></div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button id="butt" class="layui-btn" lay-submit lay-filter="formDemo" style="margin-left:80px;background-color:#1E9FFF">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary" style="margin-left:140px">重置</button>
        </div>
        <input type="hidden" name="createdate">
        <input type="hidden" name="dateofcollection">
        <input type="hidden" name="contract_file">
    </div>
</form>
</body>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
    $(document).ready(function (e) {
        goods_type();
        norms_type();
        manufacturer();
        $("#goods").change(function () {
            goods_type();
            norms_type();
            manufacturer();
        })
    })
    function goods_type(){
        var goods=$("#goods").find('option:selected').html();
        $.ajax({
            url:'{:url("index/goods/type_join")}',
            method:'post',
            data:{goods:goods},
            success:function(res){
                if(res){
                    norms_type();
                }
            }
        })
    }
    function norms_type(){
        var goods=$("#goods").find('option:selected').html();
        $.ajax({
            url:'{:url("index/goods/type_join")}',
            method:'post',
            data:{goods_type:goods},
            success:function(res){
                if(res){

                }
            }
        })
    }
    function manufacturer(){
        var goods=$("#goods").find('option:selected').html();
        $.ajax({
            url:'{:url("index/goods/type_join")}',
            method:'post',
            data:{goods_type:goods},
            success:function(res){
                if(res){

                }
            }
        })
    }
    $('#layuipro').click(function () {
        layer.open({
            type: 1
            ,closeBtn: 2
            ,shadeClose: true
            ,offset: ['55px', '90px']
            ,anim: 1
            ,area: ['80%', '80%']
            ,btn:['确定','取消']
            ,shade: 0.8
            ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
            ,btnAlign: 'c'
            ,moveType: 1 //拖拽模式，0或者1
            ,content: $("#goodsInfo")
            ,yes:function () {
                var goods=$("#goods").find('option:selected').html();
                var goods_type=$("#goods_type").find('option:selected').html();
                var norms_name=$("#norms_name").find('optin:selected').html();
                var manufacturer=$("#manufacturer").find('optin:selected').html();
                var price=$("input[name='price']").val();
                var num=$("input[name='num']").val();
                var unit=$("input[name='unit']").val();
//                if(goods && goods_type && price && num && unit){
//                    console.log(goods);
//                    layer.msg('请填写必选项！');
//                }else{
//                    console.log(goods);
//                }
            }

        });

    })


    layui.use('laydate', function(){
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#test1' //指定元素
            ,done:function (value) {
                $('input[name="createdate"]').val(value);
            }
        });
        //执行一个laydate实例
        laydate.render({
            elem: '#test2' //指定元素
            ,done:function (value) {
                $('input[name="dateofcollection"]').val(value);
            }
        });
    });
    layui.use('upload',function () {
        var upload = layui.upload;
        var demoListView = $('#demoList');
        upload.render({
            elem: '#test3'
            ,url: '{:url("index/contract/images")}'
            ,auto: false //选择文件后不自动上传
            ,bindAction: '#butt' //指向一个按钮触发上传
            ,field:'cadd'
            ,choose: function(obj){
                //将每次选择的文件追加到文件队列
                var files = obj.pushFile();

                //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function(index, file, result){
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));
                    //单个重传
                    tr.find('.demo-reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    demoListView.append(tr);
//                    console.log(index); //得到文件索引
//                    console.log(file); //得到文件对象
//                    console.log(result); //得到文件base64编码，比如图片
                    //这里还可以做一些 append 文件列表 DOM 的操作
                    //obj.upload(index, file); //对上传失败的单个文件重新上传，一般在某个事件中使用
                    //delete files[index]; //删除列表中对应的文件，一般在某个事件中使用
                });

            }
            ,done:function (res,index,upload) {
                if(res.status=='success'){
                    $('input[name="contract_file"]').val(res.msg);
                }else{
                    $('input[name="contract_file"]').val();
                }
            }
        });
    })
    layui.use('form', function(){
        var form = layui.form;
        form.on('submit(formDemo)', function(data){
            var dataobj=data.field;
            $.ajax({
                url:"{:url('index/contract/cadd_data')}",
                type:"post",
                data:{formdata:JSON.stringify(dataobj)},
                success:function (res) {
                    res=JSON.parse(res);
                    if(res.status=='success'){
                        layer.msg(res.msg);
                    }else{
                        layer.msg(res.msg);
                    }
                },
                error:function () {
                    alert('网络错误!!!');
                }
            })
            return false;
        });
    });



</script>
</html>

