<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Document</title>
    <link rel="stylesheet" href="__STATIC__/layui/css/layui.css"  media="all">
    <script type="text/javascript" src="__STATIC__/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="__STATIC__/layer/layer/layer.js"></script>
    <script src="__STATIC__/layui/layui.js"></script>
    <style>
        table input[type='text']{
            width:100%;
            height:100%;}
        .layui-table td{
            padding:0 10px;
        }
        .layui-table{
            margin-top: 0;
        }
        .channel_mon{
            display:none;
        }
    </style>
</head>
<body>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
    <legend>
        <button type="button" class="layui-btn layui-btn-normal addGoods"><i class="layui-icon">&#xe654;</i>添加商品</button>
    </legend>
</fieldset>
<form class="layui-form" action="" enctype="multipart/form-data">
    <div style="width: 98%;padding: 5px;border:2px solid skyblue">
        <table class="layui-table">
          <colgroup>
            <col  width="200">
            <col>
            <col>
            <col>
            <col>
          </colgroup>
          <thead>
            <tr>
              <th>商品名称</th>
              <th>单价</th>
              <th>数量</th>
              <th>单位</th>
              <th>总价</th>
              <th>操作</th>
            </tr> 
          </thead>
          <tbody class="goods_tbody">
            
          </tbody>
        </table>        
    </div>

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
    </fieldset>
    <div class="layui-form-item">
        <label class="layui-form-label">客户名称:</label>
        <div class="layui-input-inline">
            <input type="text" name="business_name" lay-verify="required" placeholder="请输入名称" autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">合同金额:</label>
        <div class="layui-input-inline">
            <input type="text" name="money" lay-verify="required" placeholder="请输入金额" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div style="margin-top: 20px;"></div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width:88px">对应采购合同:</label>
        <div class="layui-input-inline">
            <input type="text" name="cg_contract_id" laceholder="请输入" autocomplete="off"  placeholder="填写采购合同编号(可选填)" class="layui-input">
        </div>
            <label class="layui-form-label" style="width:88px">最迟付款时间</label>
            <div class="layui-inline"> <!-- 注意：这一层元素并不是必须的 -->
                <input type="text" class="layui-input" id="test2">
            </div>
    </div>
    <div style="margin-top: 20px;"></div>
    <div class="layui-form-item">
        <button style="margin-left:50px" type="button" class="layui-btn layui-btn-normal" id="test3"><i class="layui-icon">&#xe654;</i>选择附件照片</button>
        <!--<button type="button"  class="layui-btn layui-btn-normal" ><i class="layui-icon">&#xe67c;</i>选择附件照片</button>-->
    </div>
    <div class="layui-upload-list">
        <table class="layui-table">
            <thead>
            <tr><th>文件名</th>
                <th>大小</th>
                <th>状态</th>
                <th>操作</th>
            </tr></thead>
            <tbody id="demoList"></tbody>
        </table>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button id="butt" class="layui-btn" lay-submit lay-filter="formDemo" style="margin-left:80px;background-color:#1E9FFF">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary" style="margin-left:140px">重置</button>
        </div>
        <input type="hidden" name="contract_file">
        <input type="hidden" name="createdate">
        <input type="hidden" name="dateofcollection">
    </div>
</form>
</body>
<script>
    layui.use('laydate', function(){
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#test1' //指定元素
            ,done:function (value) {
                $('input[name="createdate"]').val(value);
            }
        });
        //执行一个laydate实例
        laydate.render({
            elem: '#test2' //指定元素
            ,done:function (value) {
                $('input[name="dateofcollection"]').val(value);
            }
        });
    });

    layui.use('upload',function () {
        var upload = layui.upload;
        var demoListView = $('#demoList');
        upload.render({
            elem: '#test3'
            ,url: '{:url("index/contract/images")}'
            ,field:'xadd'
            ,auto: false //选择文件后不自动上传
            ,method:"post"
            ,multiple:true
            ,bindAction: '#butt' //指向一个按钮触发上传
            ,choose: function(obj){
                //将每次选择的文件追加到文件队列
                var files = obj.pushFile();

                //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function(index, file, result){
                    var tr = $(['<tr id="upload-'+ index +'">'
                        ,'<td>'+ file.name +'</td>'
                        ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
                        ,'<td>等待上传</td>'
                        ,'<td>'
                        ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                        ,'</td>'
                        ,'</tr>'].join(''));
                    //单个重传
                    tr.find('.demo-reload').on('click', function(){
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function(){
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });
                    demoListView.append(tr);
//                    console.log(index); //得到文件索引
//                    console.log(file); //得到文件对象
//                    console.log(result); //得到文件base64编码，比如图片

                    //obj.resetFile(index, file, '123.jpg'); //重命名文件名，layui 2.3.0 开始新增

                    //这里还可以做一些 append 文件列表 DOM 的操作

                    //obj.upload(index, file); //对上传失败的单个文件重新上传，一般在某个事件中使用
                    //delete files[index]; //删除列表中对应的文件，一般在某个事件中使用
                });
            }
            ,done:function (res,index,upload) {
                if(res.status == 'success'){
                    $('input[name="contract_file"]').val(res.msg);
                }else{
                    $('input[name="contract_file"]').val();
                }

            }
        });
    })

    layui.use('form', function(){
        var form = layui.form;
        form.on('submit(formDemo)', function(data){
            var dataobj=data.field;
            $.ajax({
                url:"{:url('index/contract/xadd_data')}",
                type:"post",
                data:{formdata:JSON.stringify(dataobj)},
                success:function (res) {
                    res=JSON.parse(res);
                    if(res.status=='success'){
                        layer.msg(res.msg);
                    }else{
                        layer.msg(res.msg);
                    }
                },
                error:function () {
                    alert('网络错误!!!');
                }
            })
            return false;
        });
    });

// 添加商品
 var goodsArr = [];  //所有商品的数组
    $(".addGoods").on("click",function(){
    var index = layer.open({
          title: '添加商品',
          type:1,
          btn:['确定','取消'],
          btnAlign:"c",
          area:['400px'],
          content: $("#goodsInfo"),
          yes:function(){
            var good = {};
            var name = $("select[name='goods']").val().trim(),price = $("input[name='price']").val().trim(),num = $("input[name='num']").val().trim();
            var oName = $("select[name='goods']").find("option:selected").html();
            var allPrice = parseInt(price)*parseInt(num);
            if(name && price && num != ""){
                // 渲染table
                var _html = "<tr>";
                _html += "<td class='idval' style='display:none'>"+name+"</td>";
                _html += "<td>"+oName+"</td>";
                _html += "<td>"+price+"</td>";
                _html += "<td>"+num+"</td>";
                _html += "<td>元</td>";
                _html += "<td>"+allPrice+"</td>";
                _html += "<td><a href='#' class='layui-btn layui-btn-xs layui-btn-danger del'>删除</a></td>";
                _html += "</tr>";
                $(".layui-table .goods_tbody").append(_html);
                good['name'] = name;
                good['price'] = price;
                good['num'] = num;
                
                layer.close(index) 
            }else{
                layer.msg("请将信息填写完整！");
            }
            goodsArr.push(good);
            console.log(goodsArr)
        }
    })
   })

// table 中 删除按钮
    $(".layui-table").on("click",".del",function(){
        
        $(this).parents("tr").remove();
        var index = Number($(this).parent().siblings(".idval").html());
        goodsArr = goodsArr.filter(function(item){
            return item.name != index
        })
        console.log(goodsArr)
    })
</script>
</html>

<div id="goodsInfo">
    <form class="layui-form" id="goodsinfo_form">
        <div class="layui-form-item">
            <label class="layui-form-label">商品名称</label>
            <div class="layui-input-inline">
              <select name="goods" lay-verify="">
                <option value="0">商品0</option>
                <option value="6">商品1</option>
                <option value="7">商品2</option>
                <option value="8">商品3</option>
              </select>
            </div>
        </div>
        <div class="layui-form-item">
              <label class="layui-form-label">单价</label>
              <div class="layui-input-inline">
                <input type="number" name="price" placeholder="请填写单价" autocomplete="off" class="layui-input">
              </div>
              <div class="layui-form-mid layui-word-aux">/<span>元</span></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数量</label>
            <div class="layui-input-inline">
              <input type="number" name="num" required  lay-verify="required" placeholder="请输入数量" autocomplete="off" class="layui-input">
            </div>
        </div>
        
    </form>
</div>